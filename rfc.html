<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Request for Change</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">

        <h1 class="mb-4">Request for Change</h1>
        <div class="alert alert-info alert-dismissible fade show rfc-panel" role="alert">
            <h4 class="alert-heading">About this form</h4>
            <p>This form helps you log IT changes quickly and clearly. Just fill in the details so everyone involved
                knows what’s happening and why — making the whole process smoother and less risky. Learn more about <a
                    href="https://en.wikipedia.org/wiki/Change_management_(ITSM)" target="_blank"
                    rel="noopener noreferrer">IT change management</a>.</p>
            <p><small><em>Note:</em> All the information you enter is stored only in your browser. To keep a record or
                    share it, make sure to save the form locally or email the saved file to the next person involved.
                    The data isn’t sent anywhere automatically.</small></p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <script>
            // Fallback to ensure the panel is removed from the DOM when closed.
            document.addEventListener('click', function (e) {
                const btn = e.target.closest('.btn-close');
                if (!btn) return;
                const panel = btn.closest('.rfc-panel');
                if (panel) panel.remove();
            });
        </script>


        <form id="form">
            <fieldset class="mb-4">
                <legend>Reference information</legend>
                <div class="row mb-3" id="rfcIdGroup">
                    <div class="col-md-3">
                        <label for="orgId" class="form-label">Organization ID</label>
                        <input type="text" class="form-control" id="orgId" name="orgId" required
                            placeholder="e.g. ACME or dept-code — organization identifier" data-bs-toggle="tooltip"
                            data-bs-placement="top"
                            title="Short organization identifier used in the RFC ID (e.g. ACME or dept-code).">
                    </div>
                    <div class="col-md-3">
                        <label for="ticketType" class="form-label">Ticket Type</label>
                        <input type="text" class="form-control" id="ticketType" name="ticketType" value="CHG" readonly>
                    </div>
                    <div class="col-md-3">
                        <label for="changeDate" class="form-label">Date (YYYYMMDD)</label>
                        <input type="text" class="form-control" id="changeDate" name="changeDate" pattern="\d{8}"
                            placeholder="YYYYMMDD" required data-bs-toggle="tooltip" data-bs-placement="top"
                            title="Enter the date as YYYYMMDD (e.g. 20251019). This value is used in the RFC ID.">
                    </div>
                    <div class="col-md-3">
                        <label for="uniqueSuffix" class="form-label">Unique Suffix</label>
                        <input type="text" class="form-control" id="uniqueSuffix" name="uniqueSuffix" required
                            placeholder="e.g. 001 — unique short suffix" data-bs-toggle="tooltip"
                            data-bs-placement="top"
                            title="Unique short identifier used in the RFC ID (e.g. 001 or sequence). Avoid spaces; use alphanumerics or hyphens.">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="generalSubject" class="form-label">Subject</label>
                    <input type="text" class="form-control" id="generalSubject" name="generalSubject"
                        placeholder="Brief summary of the change" required data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        title="One-line summary of the change; appears in the RFC title and iCal summary. Keep it short.">
                </div>
            </fieldset>



            <fieldset class="mb-4">
                <legend>General Information</legend>
                <div class="mb-3">
                    <label for="generalDesc" class="form-label">Description</label>
                    <textarea class="form-control" id="generalDesc" name="generalDesc" rows="2"
                        placeholder="Explain what is changing, why, and what systems are affected."
                        data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Explain what is changing, why, and what systems are affected."></textarea>
                </div>
                <script>
                    window.addEventListener('load', function () {
                        var el = document.getElementByTagName('textarea');
                        if (el && typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                            new bootstrap.Tooltip(el);
                        }
                    });
                </script>
                <div class="mb-3">
                    <label for="relatedFactors">Related Factors</label><br>
                    <textarea class="form-control" id="relatedFactors" name="relatedFactors" rows="5"
                        placeholder="List any related changes, dependencies, constraints, approvals needed, timing considerations, impacted systems, or other factors that may affect or be affected by this change. For example: dependent on Change #123, requires Compliance approval, must occur during maintenance window, impacts database performance, or resource availability."
                        data-bs-toggle="tooltip" data-bs-placement="top"
                        title="List any related changes, dependencies, constraints, approvals needed, timing considerations, impacted systems, or other factors that may affect or be affected by this change. For example: dependent on Change #123, requires Compliance approval, must occur during maintenance window, impacts database performance, or resource availability."></textarea>
                </div>



                <div class="mb-3">
                    <label for="requester" class="form-label">Requester</label>
                    <input type="text" class="form-control" id="requester" name="requester"
                        placeholder="Person owning the business case for the change" required>
                </div>
                <div class="mb-3">
                    <label for="distribution" class="form-label">Distribution</label>
                    <input type="text" class="form-control" id="distribution" name="distribution"
                        placeholder="e.g. team, department, or recipients">
                </div>
            </fieldset>
            <!-- Classification Field Group -->
            <fieldset class="mb-4">
                <legend>Approval</legend>
                <div class="mb-3">
                    <label class="form-label">Approval status</label>
                    <div class="btn-group-vertical w-100" role="group" aria-label="Status">
                        <input type="radio" class="btn-check" name="status" id="statusDraft" value="Draft"
                            autocomplete="off" checked>
                        <label class="btn btn-outline-primary text-start" for="statusDraft">
                            <strong>Draft</strong><br>
                            <small class="text-muted">Initial authoring state — details may be incomplete and the change has not been submitted for review.</small>
                        </label>

                        <input type="radio" class="btn-check" name="status" id="statusSubmitted" value="Submitted"
                            autocomplete="off">
                        <label class="btn btn-outline-primary text-start" for="statusSubmitted">
                            <strong>Submitted</strong><br>
                            <small class="text-muted">Sent for review — awaiting feedback, scheduling, dependency and risk analysis .</small>
                        </label>

                        <input type="radio" class="btn-check" name="status" id="statusReadyApproval" value="Ready for Approval"
                            autocomplete="off">
                        <label class="btn btn-outline-primary text-start" for="statusReadyApproval">
                            <strong>Ready for Approval</strong><br>
                            <small class="text-muted">All required information completed and validated — now awaiting sign-off.</small>
                        </label>

                        <input type="radio" class="btn-check" name="status" id="statusApproved" value="Approved"
                            autocomplete="off">
                        <label class="btn btn-outline-primary text-start" for="statusApproved">
                            <strong>Approved</strong><br>
                            <small class="text-muted">Authorized by the approver(s) or CAB — ready for implementation.</small>
                        </label>

                        <input type="radio" class="btn-check" name="status" id="statusImplemented" value="Implemented"
                            autocomplete="off">
                        <label class="btn btn-outline-primary text-start" for="statusImplemented">
                            <strong>Implemented</strong><br>
                            <small class="text-muted">Change has been executed — monitoring and post-implementation review may be in progress.</small>
                        </label>

                        <input type="radio" class="btn-check" name="status" id="statusClosed" value="Closed"
                            autocomplete="off">
                        <label class="btn btn-outline-primary text-start" for="statusClosed">
                            <strong>Closed</strong><br>
                            <small class="text-muted">Change completed and verified — records updated and the RFC is formally closed.</small>
                        </label>
                    </div>
                </div>
           
            
                <div class="mb-3">
                    <label class="form-label">Change management procedure</label>
                    <div class="btn-group-vertical w-100" role="group" aria-label="Change Procedure options">

                        <input type="radio" class="btn-check" name="changeProcedure" id="changeNormal"
                            autocomplete="off" value="normal">
                        <label class="btn btn-outline-primary text-start" for="changeNormal">
                            <strong>Normal</strong><br>
                            <small class="text-muted">Goes through full CAB approval process; used for most planned,
                                non-routine changes.</small>
                        </label>

                        <input type="radio" class="btn-check" name="changeProcedure" id="changeStandard"
                            autocomplete="off" value="standard">
                        <label class="btn btn-outline-primary text-start" for="changeStandard">
                            <strong>Standard</strong><br>
                            <small class="text-muted">Pre-approved, low-risk, and repeatable change with a well-defined
                                release and deployment process.</small>
                        </label>

                        <input type="radio" class="btn-check" name="changeProcedure" id="changeEmergency"
                            autocomplete="off" value="emergency">
                        <label class="btn btn-outline-primary text-start" for="changeEmergency">
                            <strong>Emergency</strong><br>
                            <small class="text-muted">Urgent change to fix a major incident or prevent serious
                                disruption to service. </small>
                        </label>
                        <input type="radio" class="btn-check" name="changeProcedure" id="changeExternal"
                            autocomplete="off" value="external">
                        <label class="btn btn-outline-primary text-start" for="changeExternal">
                            <strong>External</strong><br>
                            <small class="text-muted">Third-party managed — coordination and documentation
                                required.</small>
                        </label>
                    </div>
                </div>


                <div class="mb-3">
                    <label class="form-label">Change Priority</label>
                    <div class="btn-group-vertical w-100" role="group" aria-label="Change Priority options">

                        <input type="radio" class="btn-check" name="changePriority" id="priorityExpedited"
                            value="expedited" autocomplete="off">
                        <label class="btn btn-outline-primary text-start" for="priorityExpedited">
                            <strong>Expedited</strong><br>
                            <small class="text-muted">Time-critical change required to meet a hard deadline or prevent
                                disruption. Must be acted on immediately.</small>
                        </label>

                        <input type="radio" class="btn-check" name="changePriority" id="priorityHigh" value="high"
                            autocomplete="off">
                        <label class="btn btn-outline-primary text-start" for="priorityHigh">
                            <strong>High</strong><br>
                            <small class="text-muted">Urgent change with near-term deadline or strong business need.
                                Should be prioritized.</small>
                        </label>

                        <input type="radio" class="btn-check" name="changePriority" id="priorityMedium" value="medium"
                            autocomplete="off">
                        <label class="btn btn-outline-primary text-start" for="priorityMedium">
                            <strong>Medium</strong><br>
                            <small class="text-muted">Planned change on the roadmap. Needs timely delivery but follows
                                standard workflow.</small>
                        </label>

                        <input type="radio" class="btn-check" name="changePriority" id="priorityLow" value="low"
                            autocomplete="off">
                        <label class="btn btn-outline-primary text-start" for="priorityLow">
                            <strong>Low</strong><br>
                            <small class="text-muted">Optional change with no immediate deadline. Can be deferred or
                                scheduled flexibly.</small>
                        </label>

                    </div>
                </div>





            </fieldset>

            <!-- Risks Field Group -->
            <fieldset class="mb-4">
                <legend>Risks</legend>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Implementation Complexity</label>
                        <div class="btn-group-vertical w-100" role="group"
                            aria-label="Implementation Complexity options">

                            <input type="radio" class="btn-check" name="changeComplexity" id="complexityLow" value="low"
                                autocomplete="off">
                            <label class="btn btn-outline-primary text-start" for="complexityLow">
                                <strong>Low Complexity</strong><br>
                                <small class="text-muted">Simple, well-isolated change. Minimal effort, easy to
                                    implement and test.</small>
                            </label>

                            <input type="radio" class="btn-check" name="changeComplexity" id="complexityModerate"
                                value="moderate" autocomplete="off">
                            <label class="btn btn-outline-primary text-start" for="complexityModerate">
                                <strong>Moderate Complexity</strong><br>
                                <small class="text-muted">Involves multiple components or teams. Requires coordination
                                    and moderate effort.</small>
                            </label>

                            <input type="radio" class="btn-check" name="changeComplexity" id="complexityHigh"
                                value="high" autocomplete="off">
                            <label class="btn btn-outline-primary text-start" for="complexityHigh">
                                <strong>High Complexity</strong><br>
                                <small class="text-muted">Broad or technically challenging. Requires significant design,
                                    testing, and planning.</small>
                            </label>

                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Impact Severity</label>
                        <div class="btn-group-vertical w-100" role="group" aria-label="Impact Severity options">

                            <input type="radio" class="btn-check" name="impactSeverity" id="impactLow" value="low"
                                autocomplete="off">
                            <label class="btn btn-outline-primary text-start" for="impactLow">
                                <strong>Low Impact</strong><br>
                                <small class="text-muted">Minimal disruption. Failure is tolerable and easy to recover
                                    from.</small>
                            </label>

                            <input type="radio" class="btn-check" name="impactSeverity" id="impactModerate"
                                value="moderate" autocomplete="off">
                            <label class="btn btn-outline-primary text-start" for="impactModerate">
                                <strong>Moderate Impact</strong><br>
                                <small class="text-muted">Noticeable disruption to parts of the system or user
                                    experience. Recoverable.</small>
                            </label>

                            <input type="radio" class="btn-check" name="impactSeverity" id="impactHigh" value="high"
                                autocomplete="off">
                            <label class="btn btn-outline-primary text-start" for="impactHigh">
                                <strong>High Impact</strong><br>
                                <small class="text-muted">Severe disruption or business-critical failure. </small>
                            </label>

                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Repeatability and confidence</label>
                        <div class="btn-group-vertical w-100" role="group" aria-label="Repeatability options">

                            <input type="radio" class="btn-check" name="repeatability" id="repeatHigh"
                                autocomplete="off" value="high">
                            <label class="btn btn-outline-primary text-start" for="repeatHigh">
                                <strong>High</strong><br>
                                <small class="text-muted">Frequently done, well-documented, and consistently
                                    successful.</small>
                            </label>

                            <input type="radio" class="btn-check" name="repeatability" id="repeatMedium"
                                autocomplete="off" value="medium">
                            <label class="btn btn-outline-primary text-start" for="repeatMedium">
                                <strong>Medium</strong><br>
                                <small class="text-muted">Occasionally done; some experience, but process or environment
                                    may vary.</small>
                            </label>

                            <input type="radio" class="btn-check" name="repeatability" id="repeatLow" autocomplete="off"
                                value="low">
                            <label class="btn btn-outline-primary text-start" for="repeatLow">
                                <strong>Low</strong><br>
                                <small class="text-muted">Rare or first-time change; little or no precedent; high
                                    uncertainty.</small>
                            </label>

                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Rollback Capability</label>
                        <div class="btn-group-vertical w-100" role="group" aria-label="Rollback Capability options">

                            <input type="radio" class="btn-check" name="rollbackCapability" id="rollbackFull"
                                value="full" autocomplete="off">
                            <label class="btn btn-outline-primary text-start" for="rollbackFull">
                                <strong>Full Rollback Possible</strong><br>
                                <small class="text-muted">Change can be fully reverted with minimal effort and
                                    impact.</small>
                            </label>

                            <input type="radio" class="btn-check" name="rollbackCapability" id="rollbackPartial"
                                value="partial" autocomplete="off">
                            <label class="btn btn-outline-primary text-start" for="rollbackPartial">
                                <strong>Partial Rollback Possible</strong><br>
                                <small class="text-muted">Some parts can be undone; manual steps and some impact
                                    possible.</small>
                            </label>

                            <input type="radio" class="btn-check" name="rollbackCapability" id="rollbackNone"
                                value="none" autocomplete="off">
                            <label class="btn btn-outline-primary text-start" for="rollbackNone">
                                <strong>No Rollback / Irreversible</strong><br>
                                <small class="text-muted">Change cannot be easily undone; rollback is complex or
                                    risky.</small>
                            </label>

                        </div>
                    </div>
                </div>



                <div class="mb-3">
                    <label for="riskAssessment" class="form-label">Assessment</label>
                    <textarea class="form-control" id="riskAssessment" name="riskAssessment" rows="6" placeholder="Consider the following:
- What could go wrong during or after the change?
- What is the likelihood and potential impact?
- Which systems, users, or services could be affected?
- Are there any dependencies or external risks?
- Have similar changes been done before? How confident are you?" title="Consider the following:
- What could go wrong during or after the change?
- What is the likelihood and potential impact?
- Which systems, users, or services could be affected?
- Are there any dependencies or external risks?
- Have similar changes been done before? How confident are you?" data-bs-toggle="tooltip"
                        data-bs-placement="top"></textarea>
                </div>
                <div class="mb-3">
                    <label for="riskMitigation" class="form-label">Mitigation</label>
                    <textarea class="form-control" id="riskMitigation" name="riskMitigation" rows="6" placeholder="Consider the following:
- How will you reduce the likelihood or impact of failure?
- What safeguards or precautions will be in place?
- Is there a rollback or recovery plan if something goes wrong?
- Will you test or validate the change beforehand?
- Who will monitor the change and respond to issues?" title="Consider the following:
- How will you reduce the likelihood or impact of failure?
- What safeguards or precautions will be in place?
- Is there a rollback or recovery plan if something goes wrong?
- Will you test or validate the change beforehand?
- Who will monitor the change and respond to issues?" data-bs-toggle="tooltip" data-bs-placement="top"></textarea>
                </div>
            </fieldset>

            <!-- Scheduling Field Group -->
            <fieldset class="mb-4">
                <legend>Scheduling</legend>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="scheduleStart" class="form-label">Start Date</label>
                        <input type="datetime-local" class="form-control" id="scheduleStart" name="scheduleStart">
                    </div>
                    <div class="col-md-6">
                        <label for="scheduleEnd" class="form-label">End Date</label>
                        <input type="datetime-local" class="form-control" id="scheduleEnd" name="scheduleEnd">
                    </div>
                </div>
            </fieldset>

            <fieldset class="mb-4">
                <legend>Post Implementation Review</legend>

                <!-- Change Outcome -->
                <div class="mb-3">
                    <label class="form-label">Change Outcome</label>
                    <div class="btn-group-vertical w-100" role="group" aria-label="Change Outcome options">
                        <input type="radio" class="btn-check" name="changeOutcome" id="outcomeSuccess" value="success"
                            autocomplete="off">
                        <label class="btn btn-outline-primary text-start" for="outcomeSuccess">
                            <strong>Successful</strong><br>
                            <small class="text-muted">Change was implemented as planned in schedule with no major
                                issues.</small>
                        </label>

                        <input type="radio" class="btn-check" name="changeOutcome" id="outcomePartial" value="partial"
                            autocomplete="off">
                        <label class="btn btn-outline-primary text-start" for="outcomePartial">
                            <strong>Partially Successful</strong><br>
                            <small class="text-muted">Change completed with some issues or follow-up needed.</small>
                        </label>

                        <input type="radio" class="btn-check" name="changeOutcome" id="outcomeFailed" value="failed"
                            autocomplete="off">
                        <label class="btn btn-outline-primary text-start" for="outcomeFailed">
                            <strong>Failed / Rolled Back</strong><br>
                            <small class="text-muted">Change failed or had to be reverted.</small>
                        </label>

                        <input type="radio" class="btn-check" name="changeOutcome" id="outcomeNotImplemented"
                            value="not_implemented" autocomplete="off">
                        <label class="btn btn-outline-primary text-start" for="outcomeNotImplemented">
                            <strong>Not Implemented</strong><br>
                            <small class="text-muted">Change was not carried out.</small>
                        </label>
                    </div>
                </div>

                <!-- Implementation Summary -->
                <div class="mb-3">
                    <label for="postSummary" class="form-label">Implementation Summary</label>
                    <textarea class="form-control" id="postSummary" name="postSummary" rows="2"
                        placeholder="What happened during the change? Any deviations from the plan?"
                        title="What happened during the change? Any deviations from the plan?"></textarea>
                </div>

                <!-- Issues or Incidents -->
                <div class="mb-3">
                    <label for="postIssues" class="form-label">Issues or Incidents</label>
                    <textarea class="form-control" id="postIssues" name="postIssues" rows="2"
                        placeholder="Any problems, errors, or impacts observed during or after the change?"
                        title="Any problems, errors, or impacts observed during or after the change?"></textarea>
                </div>
            </fieldset>


            <button type="submit" class="btn btn-primary">Save</button>
            <a id="shareUrl" class="btn btn-outline-secondary ms-2" target="_blank" rel="noopener noreferrer">Share link</a>

            <script>
            (function () {
                const form = document.getElementById('form');
                const share = document.getElementById('shareUrl');

                function serializeFormToHash() {
                    const params = new URLSearchParams();
                    const elements = Array.from(form.elements).filter(el => el.name);
                    elements.forEach(el => {
                        const name = el.name;
                        const tag = el.tagName;
                        const type = (el.type || "").toLowerCase();

                        if (type === 'radio') {
                            if (el.checked) params.append(name, el.value);
                        } else if (type === 'checkbox') {
                            if (el.checked) params.append(name, el.value);
                        } else if (tag === 'SELECT') {
                            if (el.multiple) {
                                Array.from(el.options).forEach(opt => { if (opt.selected) params.append(name, opt.value); });
                            } else {
                                params.append(name, el.value || '');
                            }
                        } else { // input / textarea
                            params.append(name, el.value || '');
                        }
                    });
                    return params.toString();
                }

                function updateShareHref() {
                    const base = location.href.split('#')[0];
                    const hash = serializeFormToHash();
                    share.href = base + (hash ? ('#' + hash) : '');
                    share.title = share.href;
                }

                function applyHashToForm(rawHash) {
                    if (!rawHash) return;
                    const params = new URLSearchParams(rawHash);
                    const map = {};
                    for (const [k, v] of params.entries()) {
                        if (!map[k]) map[k] = [];
                        map[k].push(v);
                    }

                    // Apply values
                    Array.from(form.elements).forEach(el => {
                        if (!el.name) return;
                        const name = el.name;
                        const vals = map[name];
                        const tag = el.tagName;
                        const type = (el.type || "").toLowerCase();

                        if (type === 'radio') {
                            el.checked = !!(vals && vals.indexOf(el.value) !== -1);
                        } else if (type === 'checkbox') {
                            el.checked = !!(vals && vals.indexOf(el.value) !== -1);
                        } else if (tag === 'SELECT') {
                            if (el.multiple) {
                                Array.from(el.options).forEach(opt => {
                                    opt.selected = !!(vals && vals.indexOf(opt.value) !== -1);
                                });
                            } else {
                                if (vals && vals.length) el.value = vals[0];
                            }
                        } else {
                            if (vals && vals.length) el.value = vals[0];
                        }

                        // notify listeners
                        const ev = new Event('input', { bubbles: true });
                        el.dispatchEvent(ev);
                        const ch = new Event('change', { bubbles: true });
                        el.dispatchEvent(ch);
                    });

                    // best-effort update if function available
                    if (typeof updateRfcIdTitle === 'function') {
                        try { updateRfcIdTitle(); } catch (e) { /* ignore */ }
                    }
                }

                // update share url on changes (debounced)
                let t;
                function scheduleUpdate() {
                    clearTimeout(t);
                    t = setTimeout(updateShareHref, 150);
                }
                form.addEventListener('input', scheduleUpdate);
                form.addEventListener('change', scheduleUpdate);

                // initialize: if there's a fragment, populate form
                function initFromHash() {
                    const raw = location.hash ? location.hash.slice(1) : '';
                    if (raw) applyHashToForm(raw);
                    updateShareHref();
                }

                document.addEventListener('DOMContentLoaded', initFromHash);
                // in case script executes after DOMContentLoaded
                if (document.readyState === 'interactive' || document.readyState === 'complete') initFromHash();

                // clicking the share link opens the current page with serialized fragment (it's an anchor already)
                // ensure the link updates once on load
                updateShareHref();
            })();
            (function () {
                // add QR button next to the share link and a Bootstrap modal to show the QR code
                const share = document.getElementById('shareUrl');
                if (!share) return;

                // create QR button
                const qrBtn = document.createElement('button');
                qrBtn.type = 'button';
                qrBtn.id = 'qrBtn';
                qrBtn.className = 'btn btn-outline-secondary ms-2';
                qrBtn.textContent = 'QR';
                share.insertAdjacentElement('afterend', qrBtn);

                // create modal markup
                const modalId = 'qrModal';
                const modalHtml = `
            <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="${modalId}Label" aria-hidden="true">
              <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="${modalId}Label">Share URL QR Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body text-center">
                    <div id="${modalId}Loading" class="text-muted">Generating QR…</div>
                    <img id="${modalId}Img" alt="QR code" style="max-width:100%; display:none" />
                    <p id="${modalId}Url" class="mt-2 small text-break" style="display:none;"></p>
                  </div>
                  <div class="modal-footer">
                    <a id="${modalId}Download" class="btn btn-primary" download>Download PNG</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                const modalEl = document.getElementById(modalId);
                const qrImg = document.getElementById(modalId + 'Img');
                const qrDownload = document.getElementById(modalId + 'Download');
                const qrLoading = document.getElementById(modalId + 'Loading');
                const qrUrlElem = document.getElementById(modalId + 'Url');
                const bsModal = new bootstrap.Modal(modalEl);

                // dynamic script loader
                function loadScript(src) {
                    return new Promise((resolve, reject) => {
                        if (document.querySelector('script[src="' + src + '"]')) return resolve();
                        const s = document.createElement('script');
                        s.src = src;
                        s.async = true;
                        s.onload = () => resolve();
                        s.onerror = () => reject(new Error('Failed to load ' + src));
                        document.head.appendChild(s);
                    });
                }

                // generate QR using qrcode library (https://github.com/soldair/node-qrcode)
                function generateQrDataUrl(text) {
                    // prefer global QRCode.toDataURL when available
                    if (window.QRCode && typeof window.QRCode.toDataURL === 'function') {
                        return new Promise((resolve, reject) => {
                            window.QRCode.toDataURL(text, { margin: 1, width: 400 }, function (err, url) {
                                if (err) reject(err); else resolve(url);
                            });
                        });
                    }
                    // fallback: try qrious if present
                    if (window.QRious) {
                        try {
                            const qr = new QRious({ value: text, size: 400 });
                            return Promise.resolve(qr.toDataURL());
                        } catch (e) {
                            return Promise.reject(e);
                        }
                    }
                    // otherwise load qrcode library from CDN then try again
                    const cdn = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js';
                    return loadScript(cdn).then(() => {
                        if (window.QRCode && typeof window.QRCode.toDataURL === 'function') {
                            return new Promise((resolve, reject) => {
                                window.QRCode.toDataURL(text, { margin: 1, width: 400 }, function (err, url) {
                                    if (err) reject(err); else resolve(url);
                                });
                            });
                        } else {
                            return Promise.reject(new Error('No QR library available'));
                        }
                    });
                }

                // get current share URL (if share href is empty, use current location)
                function currentShareUrl() {
                    return (share && share.href) ? share.href : location.href;
                }

                // generate and show QR
                async function showQr() {
                    const url = currentShareUrl();
                    qrLoading.style.display = '';
                    qrImg.style.display = 'none';
                    qrUrlElem.style.display = 'none';
                    qrDownload.removeAttribute('href');
                    qrDownload.removeAttribute('download');

                    try {
                        const dataUrl = await generateQrDataUrl(url);
                        qrImg.src = dataUrl;
                        qrImg.style.display = '';
                        qrLoading.style.display = 'none';
                        qrUrlElem.textContent = url;
                        qrUrlElem.style.display = '';
                        const filename = (typeof getRfcId === 'function' ? (getRfcId() || 'rfc') : 'rfc') + '.png';
                        qrDownload.href = dataUrl;
                        qrDownload.download = filename;
                        bsModal.show();
                    } catch (err) {
                        qrLoading.textContent = 'Failed to generate QR';
                        console.error(err);
                        bsModal.show();
                    }
                }

                qrBtn.addEventListener('click', showQr);

                // update QR automatically if modal is open and form changes (best-effort)
                document.addEventListener('input', function () {
                    if (modalEl.classList.contains('show')) {
                        showQr();
                    }
                }, true);
                document.addEventListener('change', function () {
                    if (modalEl.classList.contains('show')) {
                        showQr();
                    }
                }, true);
            })();
            </script>
            <button type="button" class="btn btn-secondary ms-2" id="downloadIcal">Download iCal</button>

        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">

        window.addEventListener('load', function () {
            var el = document.getElementByTagName('textarea');
            if (el && typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                new bootstrap.Tooltip(el);
            }
        });

        function getRfcId() {
            const orgId = document.getElementById('orgId').value.trim();
            const ticketType = document.getElementById('ticketType').value.trim();
            const changeDate = document.getElementById('changeDate').value.trim();
            const uniqueSuffix = document.getElementById('uniqueSuffix').value.trim();
            const parts = [orgId, ticketType, changeDate, uniqueSuffix].filter(Boolean);
            return parts.join('-');
        }

        document.querySelector('form').addEventListener('submit', function (e) {
            e.preventDefault();

            const form = document.getElementById("form");
            const inputs = form.querySelectorAll("input, textarea, select");

            // Set input values as default values
            inputs.forEach(input => {
                const tag = input.tagName;
                if (tag === "TEXTAREA") {
                    input.innerHTML = input.value;
                } else if (tag === "SELECT") {
                    Array.from(input.options).forEach(option => {
                        if (option.selected) {
                            option.setAttribute("selected", "selected");
                        } else {
                            option.removeAttribute("selected");
                        }
                    });
                } else if (tag === "INPUT") {
                    const type = (input.type || "").toLowerCase();
                    if (type === "radio" || type === "checkbox") {
                        if (input.checked) {
                            input.setAttribute("checked", "checked");
                        } else {
                            input.removeAttribute("checked");
                        }
                        // keep value attribute consistent as well
                        input.setAttribute("value", input.value);
                    } else {
                        input.setAttribute("value", input.value);
                    }
                }
            });

            // Get the full HTML
            const html = document.documentElement.outerHTML;

            // Create blob and download
            const blob = new Blob([html], { type: "text/html" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = getRfcId() ? getRfcId() + ".html" : "rfc.html";
            a.click();

            URL.revokeObjectURL(url);
        });

        function updateRfcIdTitle() {
            const rfcId = getRfcId();
            const subject = (document.getElementById('generalSubject')?.value || '').trim();

            const baseTitle = rfcId || "Request for Change";
            const fullTitle = subject ? `${baseTitle} - ${subject}` : baseTitle;
            document.title = fullTitle;

            const h1 = document.querySelector('h1');
            if (h1) {
            if (rfcId != "CHG" && subject) {
                h1.textContent = `${rfcId} - ${subject}`;
            } else if (rfcId != "CHG") {
                h1.textContent = rfcId;
            } else if (subject) {
                h1.textContent = `Request for Change - ${subject}`;
            } else {
                h1.textContent = "Request for Change";
            }
            }
        }

        ['orgId', 'ticketType', 'changeDate', 'uniqueSuffix', 'generalSubject'].forEach(id => {
            document.addEventListener('input', function (e) {
            if (e.target && e.target.id === id) updateRfcIdTitle();
            });
        });

        // Initialize title on load
        updateRfcIdTitle();

        document.getElementById('downloadIcal').addEventListener('click', function () {
            function pad(n) { return n < 10 ? '0' + n : String(n); }
            function toICalDateTime(dt) {
                if (!dt) return '';
                const d = new Date(dt);
                return d.getUTCFullYear() +
                    pad(d.getUTCMonth() + 1) +
                    pad(d.getUTCDate()) + 'T' +
                    pad(d.getUTCHours()) +
                    pad(d.getUTCMinutes()) +
                    pad(d.getUTCSeconds()) + 'Z';
            }

            const rfcId = getRfcId();
            const name = document.getElementById('generalSubject').value || '';
            const desc = document.getElementById('generalDesc').value || '';
            const dtStart = toICalDateTime(document.getElementById('scheduleStart').value);
            const dtEnd = toICalDateTime(document.getElementById('scheduleEnd').value);

            let ical = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//gitsm//rfc//EN',
                'BEGIN:VEVENT',
                `UID:${rfcId || (Date.now() + '@gitsm')}`,
                dtStart ? `DTSTART:${dtStart}` : '',
                dtEnd ? `DTEND:${dtEnd}` : '',
                `SUMMARY:${rfcId}${name ? ' - ' + name : ''}`,
                `DESCRIPTION:${desc}`,
                'END:VEVENT',
                'END:VCALENDAR'
            ].filter(Boolean).join('\r\n');

            const blob = new Blob([ical], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (rfcId || 'rfc') + '.ics';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>

</html>