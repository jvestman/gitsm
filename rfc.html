<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Request for Change</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Request for Change</h1>
        <p>Request for change form for <a href="https://en.wikipedia.org/wiki/Change_management_(ITSM)">IT change management</a></p>

        <form id="form">
            <!-- General Field Group -->
            <fieldset class="mb-4">
                <legend>General</legend>
                <div class="row mb-3" id="rfcIdGroup">
                    <div class="col-md-3">
                        <label for="orgId" class="form-label">Organization ID</label>
                        <input type="text" class="form-control" id="orgId" name="orgId" required placeholder="e.g. ACME or dept-code â€” organization identifier">
                    </div>
                    <div class="col-md-3">
                        <label for="ticketType" class="form-label">Ticket Type</label>
                        <input type="text" class="form-control" id="ticketType" name="ticketType" value="CHG" readonly>
                    </div>
                    <div class="col-md-3">
                        <label for="changeDate" class="form-label">Date (YYYYMMDD)</label>
                        <input type="text" class="form-control" id="changeDate" name="changeDate" pattern="\d{8}" placeholder="YYYYMMDD" required>
                    </div>
                    <div class="col-md-3">
                        <label for="uniqueSuffix" class="form-label">Unique Suffix</label>
                        <input type="text" class="form-control" id="uniqueSuffix" name="uniqueSuffix" required>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="generalSubject" class="form-label">Subject</label>
                    <input type="text" class="form-control" id="generalSubject" name="generalSubject" placeholder="Brief summary of the change" required>
                </div>
                <div class="mb-3">
                    <label for="generalDesc" class="form-label">Description</label>
                    <textarea class="form-control" id="generalDesc" name="generalDesc" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label for="requester" class="form-label">Requester</label>
                    <input type="text" class="form-control" id="requester" name="requester" placeholder="Person owning the business case for the change" required>
                </div>
                <div class="mb-3">
                    <label for="distribution" class="form-label">Distribution</label>
                    <input type="text" class="form-control" id="distribution" name="distribution" placeholder="e.g. team, department, or recipients">
                </div>
                <div class="mb-3">
                    <label class="form-label d-block">Status</label>
                    <div class="btn-group" role="group" aria-label="Status">
                        <input type="radio" class="btn-check" name="status" id="statusDraft" value="Draft" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="statusDraft">Draft</label>

                        <input type="radio" class="btn-check" name="status" id="statusSubmitted" value="Submitted" autocomplete="off">
                        <label class="btn btn-outline-primary" for="statusSubmitted">Submitted</label>

                        <input type="radio" class="btn-check" name="status" id="statusApproved" value="Approved" autocomplete="off">
                        <label class="btn btn-outline-primary" for="statusApproved">Approved</label>

                        <input type="radio" class="btn-check" name="status" id="statusImplemented" value="Implemented" autocomplete="off">
                        <label class="btn btn-outline-primary" for="statusImplemented">Implemented</label>

                        <input type="radio" class="btn-check" name="status" id="statusClosed" value="Closed" autocomplete="off">
                        <label class="btn btn-outline-primary" for="statusClosed">Closed</label>
                    </div>
                </div>
            </fieldset>

            <!-- Classification Field Group -->
            <fieldset class="mb-4">
                <legend>Classification</legend>
                <div class="mb-3">
                    <label for="classificationType" class="form-label">Type</label>
                    <select class="form-select" id="classificationType" name="classificationType">
                        <option value="">Select type</option>
                        <option value="standard">Standard</option>
                        <option value="urgent">Urgent</option>
                        <option value="emergency">Emergency</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="classificationPriority" class="form-label">Priority</label>
                    <input type="number" class="form-control" id="classificationPriority" name="classificationPriority" min="1" max="5">
                </div>
            </fieldset>

            <!-- Risks Field Group -->
            <fieldset class="mb-4">
                <legend>Risks</legend>
                <div class="mb-3">
                    <label for="riskAssessment" class="form-label">Assessment</label>
                    <textarea class="form-control" id="riskAssessment" name="riskAssessment" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label for="riskMitigation" class="form-label">Mitigation</label>
                    <textarea class="form-control" id="riskMitigation" name="riskMitigation" rows="2"></textarea>
                </div>
            </fieldset>

            <!-- Scheduling Field Group -->
            <fieldset class="mb-4">
                <legend>Scheduling</legend>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="scheduleStart" class="form-label">Start Date</label>
                        <input type="datetime-local" class="form-control" id="scheduleStart" name="scheduleStart">
                    </div>
                    <div class="col-md-6">
                        <label for="scheduleEnd" class="form-label">End Date</label>
                        <input type="datetime-local" class="form-control" id="scheduleEnd" name="scheduleEnd">
                    </div>
                </div>
            </fieldset>

            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary ms-2" id="downloadIcal">Download iCal</button>
           
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">

        function getRfcId() {
                const orgId = document.getElementById('orgId').value.trim();
                const ticketType = document.getElementById('ticketType').value.trim();
                const changeDate = document.getElementById('changeDate').value.trim();
                const uniqueSuffix = document.getElementById('uniqueSuffix').value.trim();
                const parts = [orgId, ticketType, changeDate, uniqueSuffix].filter(Boolean);
                return parts.join('-');
            }

        document.querySelector('form').addEventListener('submit', function(e) {
            e.preventDefault();

            const form = document.getElementById("form");
            const inputs = form.querySelectorAll("input, textarea, select");

            // Set input values as default values
            inputs.forEach(input => {
                if (input.tagName === "TEXTAREA") {
                input.innerHTML = input.value;
                } else if (input.tagName === "SELECT") {
                // Set the selected option as default
                Array.from(input.options).forEach(option => {
                    if (option.selected) {
                    option.setAttribute("selected", "selected");
                    } else {
                    option.removeAttribute("selected");
                    }
                });
                } else {
                input.setAttribute("value", input.value);
                }
            });

            // Get the full HTML
            const html = document.documentElement.outerHTML;

            // Create blob and download
            const blob = new Blob([html], {type: "text/html"});
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = getRfcId() ? getRfcId() + ".html" : "rfc.html";
            a.click();

            URL.revokeObjectURL(url);
        });
    
        function updateRfcIdTitle() {
            const rfcId = getRfcId();

            
            if (rfcId) {
                document.title = rfcId;
                const h1 = document.querySelector('h1');
                if (h1) h1.textContent = rfcId;
            } else {
                document.title = "Request for Change";
                const h1 = document.querySelector('h1');
                if (h1) h1.textContent = "Request for Change";
            }
        }
        ['orgId', 'ticketType', 'changeDate', 'uniqueSuffix'].forEach(id => {
            document.addEventListener('input', function(e) {
                if (e.target && e.target.id === id) updateRfcIdTitle();
            });
        });

        document.getElementById('downloadIcal').addEventListener('click', function() {
            function pad(n) { return n < 10 ? '0' + n : String(n); }
            function toICalDateTime(dt) {
                if (!dt) return '';
                const d = new Date(dt);
                return d.getUTCFullYear() +
                    pad(d.getUTCMonth() + 1) +
                    pad(d.getUTCDate()) + 'T' +
                    pad(d.getUTCHours()) +
                    pad(d.getUTCMinutes()) +
                    pad(d.getUTCSeconds()) + 'Z';
            }

            const rfcId = getRfcId();
            const name = document.getElementById('generalSubject').value || '';
            const desc = document.getElementById('generalDesc').value || '';
            const dtStart = toICalDateTime(document.getElementById('scheduleStart').value);
            const dtEnd = toICalDateTime(document.getElementById('scheduleEnd').value);

            let ical = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//gitsm//rfc//EN',
                'BEGIN:VEVENT',
                `UID:${rfcId || (Date.now() + '@gitsm')}`,
                dtStart ? `DTSTART:${dtStart}` : '',
                dtEnd ? `DTEND:${dtEnd}` : '',
                `SUMMARY:${rfcId}${name ? ' - ' + name : ''}`,
                `DESCRIPTION:${desc}`,
                'END:VEVENT',
                'END:VCALENDAR'
            ].filter(Boolean).join('\r\n');

            const blob = new Blob([ical], {type: 'text/calendar'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (rfcId || 'rfc') + '.ics';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>